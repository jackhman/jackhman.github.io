import{_ as n,F as e,g as p,K as t,h as s,ar as h,l as i,o as k}from"./chunks/framework.VlluEs-f.js";const x=JSON.parse('{"title":"17案例实战：教你快速搭建Kubernete监控平台","description":"","frontmatter":{},"headers":[],"relativePath":"posts/backEnd/113-Kubernetes 原理剖析与实战应用文档/(4534) 17  案例实战：教你快速搭建 Kubernete 监控平台.md","filePath":"posts/backEnd/113-Kubernetes 原理剖析与实战应用文档/(4534) 17  案例实战：教你快速搭建 Kubernete 监控平台.md","lastUpdated":1718371218000}'),l={name:"posts/backEnd/113-Kubernetes 原理剖析与实战应用文档/(4534) 17  案例实战：教你快速搭建 Kubernete 监控平台.md"},r=h('<h1 id="_17案例实战-教你快速搭建kubernete监控平台" tabindex="-1">17案例实战：教你快速搭建Kubernete监控平台 <a class="header-anchor" href="#_17案例实战-教你快速搭建kubernete监控平台" aria-label="Permalink to &quot;17案例实战：教你快速搭建Kubernete监控平台&quot;">​</a></h1><p><a href="https://prometheus.io/" target="_blank" rel="noreferrer">Prometheus</a> 和 <a href="https://grafana.com/" target="_blank" rel="noreferrer">Grafana</a> 可以说是 Kubernetes 监控解决方案中最知名的两个。Prometheus 负责收集、存储、查询数据，而 Grafana 负责将 Prometheus 中的数据进行可视化展示，当然 Grafana 还支持其他平台，比如 <a href="https://grafana.com/docs/grafana/latest/datasources/elasticsearch/" target="_blank" rel="noreferrer">ElasticSearch</a>、<a href="https://grafana.com/docs/grafana/latest/datasources/influxdb/" target="_blank" rel="noreferrer">InfluxDB</a>、<a href="https://grafana.com/docs/grafana/latest/datasources/graphite/" target="_blank" rel="noreferrer">Graphite</a> 等。<a href="https://www.cncf.io/blog/2020/04/24/prometheus-and-grafana-the-perfect-combo/" target="_blank" rel="noreferrer">CNCF 博客</a>也将这两者称为黄金组合，目前一些公有云提供的托管式 Kubernetes （Managed Kubernetes） 都已经默认安装了 Prometheus 和 Grafana。</p>',2),F=h(`<p>我们今天就来学习如何在 Kubernetes 集群中搭建 Prometheus 和 Grafana，使之帮我们监控 Kubernetes 集群。</p><h3 id="通过-helm-一键安装-prometheus-和-grafana" tabindex="-1">通过 Helm 一键安装 Prometheus 和 Grafana <a class="header-anchor" href="#通过-helm-一键安装-prometheus-和-grafana" aria-label="Permalink to &quot;通过 Helm 一键安装 Prometheus 和 Grafana&quot;">​</a></h3><p>还记得之前讲过的 Helm 吗？我们今天就通过 Helm 来安装相关的 Charts，一键式搭建 Prometheus 和 Grafana。如果对 Helm 的一些概念和术语还不太清楚，你可以回到第 12 讲复习一下。</p><p>首先我们先通过<code>helm repo add</code>添加一个 Helm repo，见如下命令：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> helm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> repo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prometheus-community</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://prometheus-community.github.io/helm-charts</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;prometheus-community&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> has</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> been</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> added</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> your</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> repositories</span></span></code></pre></div><p>我们从这个刚刚添加的<code>prometheus-community</code>中安装 Prometheus 的 Chart。</p><p>然后你通过<code>helm repo list</code>就可以看到当前已添加的所有 repo 列表：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> helm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> repo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> list</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                    URL</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prometheus-community</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    https://prometheus-community.github.io/helm-charts</span></span></code></pre></div><p>如果你已经添加了这个 repo，那么可以运行<code>helm repo update</code>来更新内容：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> helm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> repo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Hang</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tight</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> while</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> we</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> grab</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> latest</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> your</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> repositories...</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">..</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.Successfully</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> got</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> an</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;prometheus-community&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> repository</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">..</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.Successfully</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> got</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> an</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;bitnami&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> repository</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Update</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Complete.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ⎈Happy</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Helming!⎈</span></span></code></pre></div><p>正如我们之前讲 Helm 提到过的，Helm 的这些 repo 非常类似于我们熟悉的 YUM 源、debian 源。</p><p>回到正题上，添加了这个 helm repo 了以后，我们就可以开始安装 Prometheus 的 Chart 了。通常来说，使用 Helm 安装 Chart 的最佳实践是单独创建一个 namespace （命名空间），方便区分、隔离和管理。这里我们就创建一个名为<code>monitor</code>的 namespace:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ns</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monitor</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">namespace/monitor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> created</span></span></code></pre></div><p>创建好了 namespace，我们直接运行如下<code>helm install</code>命令进行安装:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> helm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prometheus-stack</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prometheus-community/kube-prometheus-stack</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monitor</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prometheus-stack</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">LAST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DEPLOYED:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Mon</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Oct</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 19</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 11:07:42</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2020</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAMESPACE:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monitor</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">STATUS:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deployed</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">REVISION:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NOTES:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kube-prometheus-stack</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> has</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> been</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> installed.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Check</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> its</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> by</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> running:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monitor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pods</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -l</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;release=prometheus-stack&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Visit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/prometheus-operator/kube-prometheus</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> instructions</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> how</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">configure</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Alertmanager</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> and</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Prometheus</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> instances</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> using</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Operator.</span></span></code></pre></div><p>下面我来解释下上述命令中的参数含义。</p><p>其中<code>prometheus-stack</code>是这个 helm release 的名字，当然你在实际使用时候可以换成其他名字。从这个名字的后缀<code>stack</code>就可以看出来，<code>prometheus-community/kube-prometheus-stack</code>这个 Chart 其实包含了几个组件，类似于我们之前听说过的 <a href="https://www.elastic.co/what-is/elk-stack" target="_blank" rel="noreferrer">ELKStack</a> 等。除了安装 Prometheus 相关的组件外，该 Chart 的 <a href="https://github.com/prometheus-community/helm-charts/blob/main/charts/kube-prometheus-stack/requirements.yaml" target="_blank" rel="noreferrer">requirements.yaml</a> 中还定义了三个依赖组件</p><ul><li><p><a href="https://github.com/helm/charts/tree/master/stable/kube-state-metrics" target="_blank" rel="noreferrer">stable/kube-state-metrics</a>；</p></li><li><p><a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus-node-exporter" target="_blank" rel="noreferrer">stable/prometheus-node-exporter</a>；</p></li><li><p><a href="https://github.com/grafana/helm-charts/tree/main/charts/grafana" target="_blank" rel="noreferrer">grafana/grafana</a>。</p></li></ul><p>从这个 YAML 文件可以看到这个 Chart 不仅一起安装了 Grafana，还安装了我们之前第 15 讲提到的<code>kube-state-metrics</code>和<code>prometheus-node-exporter</code>组件。</p><p>接着看<code>prometheus-community/kube-prometheus-stack</code>，它就是<code>prometheus-community</code>repo里面名为<code>kube-prometheus-stack</code>的 Chart。</p><p>最后看<code>monitor</code>，它是我们刚创建的新命名空间，在部署的时候使用。</p><p>当然如果你不想安装这些依赖，也可以通过<a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack#multiple-releases" target="_blank" rel="noreferrer">文档中的提及方法</a>更改（override）这些默认设置。</p><p>现在我们运行刚才<code>helm install</code>输出结果中的命令，来查看我们相关 Pod 的状态：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monitor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pods</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -l</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;release=prometheus-stack&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                                   READY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    RESTARTS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prometheus-stack-kube-prom-operator-6998d5c5b7-kgv8b</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   2/2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          2m41s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prometheus-stack-prometheus-node-exporter-l7pr9</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          2m41s</span></span></code></pre></div><p>这里有一个名为prometheus-stack-kube-prom-operator-6998d5c5b7-kgv8b的 Pod，它是 <a href="https://github.com/prometheus-operator/prometheus-operator" target="_blank" rel="noreferrer">prometheus-operator</a> 的一个实例，主要用于为我们创建、管理和维护 Prometheus 集群，其具体架构图如下。</p>`,25),d=h(`<p>（<a href="https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/user-guides/images/architecture.png%EF%BC%89" target="_blank" rel="noreferrer">https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/user-guides/images/architecture.png）</a></p><p>Operator 的工作流程相对复杂一些，我会在后面单独行介绍，在此先略过。有兴趣的话可以查看<a href="https://coreos.com/operators/prometheus/docs/latest/user-guides/getting-started.html" target="_blank" rel="noreferrer">官方文档</a>简单了解下。</p><p>另外一个叫prometheus-stack-prometheus-node-exporter-l7pr9的 Pod 是一个 <a href="https://github.com/prometheus/node_exporter" target="_blank" rel="noreferrer">node-exporter</a>，主要来采集 kubelet 所在节点上的 metrics。</p><p>这两个 Pod 都运行成功，我们再来看看<code>monitor</code>这个 namespace 下面其他依赖组件的状态：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monitor</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                                         READY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    RESTARTS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pod/alertmanager-prometheus-stack-kube-prom-alertmanager-0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   2/2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pod/prometheus-prometheus-stack-kube-prom-prometheus-0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       3/3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pod/prometheus-stack-grafana-5b6dd6b5fb-rtp6z</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                2/2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pod/prometheus-stack-kube-prom-operator-6998d5c5b7-kgv8b</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     2/2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pod/prometheus-stack-kube-state-metrics-c7c69c8c9-bhgjv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pod/prometheus-stack-prometheus-node-exporter-l7pr9</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                                TYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        CLUSTER-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       EXTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">S</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)                      </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">service/alertmanager-operated</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                       ClusterIP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   None</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">             &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        9093/TCP,9094/TCP,9094/UDP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">service/prometheus-operated</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                         ClusterIP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   None</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">             &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        9090/TCP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                     11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">service/prometheus-stack-grafana</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                    ClusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   10.108.122.155</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        80/TCP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                       11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">service/prometheus-stack-kube-prom-alertmanager</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     ClusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   10.103.37.81</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">     &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        9093/TCP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                     11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">service/prometheus-stack-kube-prom-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">         ClusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   10.97.75.165</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">     &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        8080/TCP,443/TCP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">             11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">service/prometheus-stack-kube-prom-prometheus</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       ClusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   10.102.82.76</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">     &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        9090/TCP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                     11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">service/prometheus-stack-kube-state-metrics</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">         ClusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   10.109.78.8</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        8080/TCP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                     11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">service/prometheus-stack-prometheus-node-exporter</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   ClusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   10.101.221.185</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        9100/TCP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                     11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                                       DESIRED</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   CURRENT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   READY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   UP-TO-DATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   AVAILABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   NODE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SELECTOR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">daemonset.apps/prometheus-stack-prometheus-node-exporter</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">       1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">           &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                                  READY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   UP-TO-DATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   AVAILABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">deployment.apps/prometheus-stack-grafana</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">              1/1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">deployment.apps/prometheus-stack-kube-prom-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   1/1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">deployment.apps/prometheus-stack-kube-state-metrics</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   1/1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                                             DESIRED</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   CURRENT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   READY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replicaset.apps/prometheus-stack-grafana-5b6dd6b5fb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replicaset.apps/prometheus-stack-kube-prom-operator-6998d5c5b7</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replicaset.apps/prometheus-stack-kube-state-metrics-c7c69c8c9</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                                                    READY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">statefulset.apps/alertmanager-prometheus-stack-kube-prom-alertmanager</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     11m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">statefulset.apps/prometheus-prometheus-stack-kube-prom-prometheus</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       1/1</span></span></code></pre></div><p>可以看到全部 Pod 都已经部署成功且运行。</p><p>prometheus-operator 以 Deployment 的形式部署，并帮助我们创建了名为 prometheus-prometheus-stack-kube-prom-prometheus 的 StatefulSet，副本数设置为 1。</p><p>接下来就可以本地来访问 Prometheus 了，通过如下命令，我们在本地通过 <a href="http://127.0.0.1:9090" target="_blank" rel="noreferrer">http://127.0.0.1:9090</a> 来访问 Prometheus：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> port-forward</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monitor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prometheus-prometheus-stack-kube-prom-prometheus-0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 9090</span></span></code></pre></div>`,9),g=h('<p>同样地，我们也可以使用如下命令，在本地通过 <a href="http://127.0.0.1:3000" target="_blank" rel="noreferrer">http://127.0.0.1:3000</a> 来访问 Grafana：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> port-forward</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monitor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prometheus-stack-grafana-5b6dd6b5fb-rtp6z</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3000</span></span></code></pre></div>',2),o=h(`<p>这里默认用户名是 admin，密码是 prom-operator。当然你也可以通过 Grafana 的配置来拿到，我们来看看如何操作。</p><p>下面是刚才 Chart 部署的 grafana Deployment 的配置：</p><div class="language-dart vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dart</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">kubectl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> deploy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n monitor prometheus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">stack</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">grafana </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">o yaml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">apiVersion</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> apps</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">v1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">kind</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Deployment</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">metadata</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prometheus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">stack</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">grafana</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  namespace</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> monitor</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">spec</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  template</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    spec</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      containers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> env</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> GF_SECURITY_ADMIN_USER</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          valueFrom</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            secretKeyRef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">              key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> admin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">              name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prometheus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">stack</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">grafana</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> GF_SECURITY_ADMIN_PASSWORD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          valueFrom</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            secretKeyRef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">              key</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> admin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">password</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">              name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> prometheus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">stack</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">grafana</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        image</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> grafana</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">grafana</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ...</span></span></code></pre></div><p>可以看到环境变量<code>GF_SECURITY_ADMIN_USER</code>和<code>GF_SECURITY_ADMIN_PASSWORD</code>就是 grafana 的登录用户名和密码，具体的值来自 Secret<code>prometheus-stack-grafana</code>。</p><p>我们接着看这个 Secret：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> secret</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prometheus-stack-grafana</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monitor</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> jsonpath=&#39;{.data}&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map[admin-password:cHJvbS1vcGVyYXRvcg</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> admin-user:YWRtaW4=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ldap-toml:]</span></span></code></pre></div><p>分别通过 base64 对其进行解码就可以得到用户名和密码：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> secret</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prometheus-stack-grafana</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monitor</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> jsonpath=&#39;{.data.admin-user}&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> base64</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --decode</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">admin</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> secret</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prometheus-stack-grafana</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monitor</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> jsonpath=&#39;{.data.admin-password}&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> base64</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --decode</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prom-operator</span></span></code></pre></div><p>使用上述用户名和密码登录，进来后就可以看到 grafana 的主页面了。</p>`,9),E=i("p",null,"按照上述图示点进来，你就可以看到已经配置好的各个 Dashboard：",-1),y=i("p",null,[s("这些都是"),i("code",null,"prometheus-community/kube-prometheus-stack"),s("这个 Chart 预先配置好的，基本上包括我们对 Kubernetes 的各项监控大盘，你可以随意点击几个 Dashboard 进行了解。")],-1),c=h('<p>你可以参考<a href="https://grafana.com/docs/grafana/latest/dashboards/" target="_blank" rel="noreferrer">官方文档</a>学习 Dashboard 的创建和数据展示能力。</p><h3 id="生产环境中一些重要的关注指标" tabindex="-1">生产环境中一些重要的关注指标 <a class="header-anchor" href="#生产环境中一些重要的关注指标" aria-label="Permalink to &quot;生产环境中一些重要的关注指标&quot;">​</a></h3><h4 id="集群状态、性能以及各个-api-对象" tabindex="-1">集群状态、性能以及各个 API 对象 <a class="header-anchor" href="#集群状态、性能以及各个-api-对象" aria-label="Permalink to &quot;集群状态、性能以及各个 API 对象&quot;">​</a></h4><p>kube-state-metrics 可以帮助我们汇聚 Kubernetes 集群中的各大信息，比如 Pod 数量，APIServer 访问请求数，Pod 调度性能，等等。你可以通过如下命令可本地访问<a href="http://127.0.0.1:8080/metrics" target="_blank" rel="noreferrer">http://127.0.0.1:8080/metrics</a>拿到相关的 metrics。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> port-forward</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> monitor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> prometheus-stack-kube-state-metrics-c7c69c8c9-bhgjv</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8080</span></span></code></pre></div>',5),C=i("h4",{id:"各节点的监控指标",tabindex:"-1"},[s("各节点的监控指标 "),i("a",{class:"header-anchor",href:"#各节点的监控指标","aria-label":'Permalink to "各节点的监控指标"'},"​")],-1),m=i("p",null,"各个节点承载着 Pod 的运行，因此对各个节点的监控至关重要，比如节点的 CPU 使用率、内存使用率、平均工作负载等。你可以通过上面 Chart 预配置好的 Node dashboard 来查看：",-1),B=h('<p>你可以通过切换节点来查看不同节点的状态，或者单独创建一个 Dashboard，添加一些指标，诸如：</p><ul><li><p><code>kube_node_status_capacity_cpu_cores</code>代表节点 CPU 容量；</p></li><li><p><code>kube_node_status_capacity_memory_bytes</code>代表节点的 Memory容量；</p></li><li><p><code>kubelet_running_container_count</code>代表节点上运行的容器数量；</p></li><li><p>......</p></li></ul><h3 id="设置-alert" tabindex="-1">设置 Alert <a class="header-anchor" href="#设置-alert" aria-label="Permalink to &quot;设置 Alert&quot;">​</a></h3><p>除了监控指标的收集和展示以外，我们还需要设置报警（Alert）。你可以通过设置合适的 Alert rules，在触发的时候通过钉钉、邮件、Slack、PagerDuty 等多种方式通知你。</p>',4),u=i("p",null,[s("在此不做太多介绍，可以通过"),i("a",{href:"https://grafana.com/docs/grafana/latest/alerting/create-alerts/",target:"_blank",rel:"noreferrer"},"官方文档"),s("来设置你的 Alert。")],-1),b=i("h3",{id:"写在最后",tabindex:"-1"},[s("写在最后 "),i("a",{class:"header-anchor",href:"#写在最后","aria-label":'Permalink to "写在最后"'},"​")],-1),_=i("p",null,"在这一小节，我们介绍了快速搭建基于 Prometheus + Grafana 的 Kubernetes 监控体系。当然安装的方式有很多，今天这里只写了最方便、最快捷的方式。Chart 里预先配置了多个 Dashboard，方便你开箱即用。",-1),A=i("p",null,"如果你对本节课有什么想法或者疑问，欢迎你在留言区留言，我们一起讨论。",-1);function f(D,v,P,T,S,R){const a=e("Image");return k(),p("div",null,[r,t(a,{alt:"Drawing 0.png",src:"https://s0.lgstatic.com/i/image/M00/61/14/CgqCHl-OrgyAPH_iAAFeouU_wAY811.png"}),s(),F,t(a,{alt:"Drawing 1.png",src:"https://s0.lgstatic.com/i/image/M00/61/09/Ciqc1F-OrkWAXJsQAAEHWw6G6rM837.png"}),s(),d,t(a,{alt:"Drawing 2.png",src:"https://s0.lgstatic.com/i/image/M00/61/14/CgqCHl-OrlyAf9PiAAW6ru2bHZI707.png"}),s(),g,t(a,{alt:"Drawing 3.png",src:"https://s0.lgstatic.com/i/image/M00/61/14/CgqCHl-OrmeAXd8PABEbqH6I_pE362.png"}),s(),o,t(a,{alt:"Drawing 4.png",src:"https://s0.lgstatic.com/i/image/M00/61/14/CgqCHl-OroiAZBPUABgqqawSub0949.png"}),s(),E,t(a,{alt:"Drawing 5.png",src:"https://s0.lgstatic.com/i/image/M00/61/14/CgqCHl-OrpKAG4VoAAs8370oK_k082.png"}),s(),y,t(a,{alt:"Drawing 6.png",src:"https://s0.lgstatic.com/i/image/M00/61/14/CgqCHl-OrtSASkD9ABXvtUrLlxI610.png"}),s(),c,t(a,{alt:"Drawing 7.png",src:"https://s0.lgstatic.com/i/image/M00/61/14/CgqCHl-Oru-AevJ5AB_ZvYnlO60668.png"}),s(),C,m,t(a,{alt:"Drawing 8.png",src:"https://s0.lgstatic.com/i/image/M00/61/09/Ciqc1F-OrvaARKZ2ABNH_bHh8sg135.png"}),s(),B,t(a,{alt:"Drawing 9.png",src:"https://s0.lgstatic.com/i/image/M00/61/14/CgqCHl-Orv6ACQ9XAAqhwgoMegs538.png"}),s(),u,b,_,A])}const N=n(l,[["render",f]]);export{x as __pageData,N as default};
